<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" content="notranslate" />
    <title>Document</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
      #div-join-wrapper,
      #div-login-info-wrapper {
        display: flex;
      }
      #user-status {
        margin-left: auto;
      }
      .main-container {
        display: flex;
        height: 50vh;
      }
      .room-wrapper {
        flex-basis: 40%;
        border: 1px solid lavender;
      }
      .chat-wrapper {
        flex-basis: 50%;
        border: 1px solid lavender;
        overflow: auto;
      }
      .user-wrapper {
        flex-basis: 10%;
        border: 1px solid lavender;
      }
      ul {
        list-style: none;
        padding-left: 0px;
      }

      ul > li > a {
        display: block;
        color: #000;
        text-decoration: none;
      }

      ul > li a:hover {
        text-decoration: underline;
        text-decoration-color: gray;
      }

      ul > li .selected {
        font-weight: 600;
        text-decoration: underline;
        text-decoration-color: #f9826c;
      }
    </style>
  </head>
  <body>
    <div class="login_container">
      <div id="div-join-wrapper">
        <div>닉네임</div>
        <div><input id="input-join" style="width: 100px" maxlength="8" autocomplete="off" placeholder="닉네임" /><button id="btn-join">Join</button></div>
        <div id="user-status"></div>
      </div>
      <div id="div-login-info-wrapper"></div>
    </div>
    <div class="main-container">
      <div class="room-wrapper">
        <ul id="ul-room-list">
          <li><a href="room1">방1</a></li>
          <li><a href="room2">방2</a></li>
        </ul>
      </div>
      <div class="chat-wrapper">
        <div class="chat-msg-area">
          <div id="ul-chat-room-status"></div>
          <ul id="ul-chat-msg"></ul>
        </div>
        <div class="chat-input-area">
          <input id="input-chat-msg" />
          <button id="btn-send-chat-msg">S</button>
        </div>
      </div>
      <div class="user-wrapper">
        <ul id="ul-user-list"></ul>
      </div>
    </div>
    <div id="div-bottom-status-bar"></div>
    <script>
      let socket = io("/nsp1"); // 접속하고자 하는 namespace
      let myInfo = { isLogin: false, nickName: "", roomName: "" };
      let tempLoginId;

      const inputJoin = document.querySelector("#input-join");
      const btnJoin = document.querySelector("#btn-join");
      const divJoinWrapper = document.querySelector("#div-join-wrapper");
      const divLoginInfoWrapper = document.querySelector("#div-login-info-wrapper");

      const ulRoomList = document.querySelector("#ul-room-list");
      const inputChatMsg = document.querySelector("#input-chat-msg");
      const btnSendChatMsg = document.querySelector("#btn-send-chat-msg");
      const ulChatMsg = document.querySelector("#ul-chat-msg");

      // 닉네임 엔터
      inputJoin.addEventListener("keyup", function (e) {
        if (e.key === "Enter") {
          e.preventDefault();
          btnJoin.click();
        }
      });

      // 로그인 클릭
      btnJoin.addEventListener("click", function (e) {
        if (inputJoin.value.trim() === "" || inputJoin.value == null) {
          alert("please enter name");
          inputJoin.focus();
          return;
        }

        if (checkSpace(inputJoin.value)) {
          alert("공백은 사용할 수 없습니다.");
          inputJoin.focus();
          return;
        }

        if (!checkKor(inputJoin.value) && !checkEng(inputJoin.value) && !checkNum(inputJoin.value)) {
          alert("한글/영문/숫자만 사용가능합니다.");
          inputJoin.focus();
          return;
        }

        if (getByteLengthOfUtf8String(inputJoin.value) > 12) {
          alert("한글4자까지 가능합니다.");
          inputJoin.focus();
          return;
        }

        tempLoginId = inputJoin.value;
        socket.emit("join user", tempLoginId);
      });

      ulRoomList.addEventListener("click", (e) => {
        e.preventDefault();
        if (!e.target.matches("#ul-room-list > li > a")) return;
        e.preventDefault();
        const path = e.target.getAttribute("href");
        console.log(path);

        if (myInfo.roomName === path) {
          alert("현재방 입니다.");
          return;
        }
        ulChatMsg.innerHTML = "";
        socket.emit("join room", { roomName: path });
        myInfo.roomName = path;

        setSelectedSideMenu(path);
      });

      inputChatMsg.addEventListener("keyup", function (e) {
        if (e.key === "Enter") {
          e.preventDefault();
          btnSendChatMsg.click();
        }
      });

      btnSendChatMsg.addEventListener("click", function () {
        console.log(myInfo);
        if (!myInfo.isLogin) {
          alert("닉네임이 필요합니다.");
          inputJoin.focus();
          return;
        }

        let chatMsg = inputChatMsg.value;
        socket.emit("chat message", { roomName: myInfo.roomName, chatMsg: chatMsg });
        inputChatMsg.value = "";
      });

      // 비로그인 접속
      socket.on("connect user", function (serverMsg) {
        inputJoin.focus();
        renderUserCount(serverMsg.loginUserList);
      });

      // 로그인
      socket.on("join user", function (serverMsg) {
        console.log("join user", serverMsg);
        /*----- 닉네임 중복체크 -----*/
        if (tempLoginId === serverMsg.nickName) {
          if (serverMsg.isLogin) {
            // 정상
            divJoinWrapper.setAttribute("style", "display:none;");
            divLoginInfoWrapper.innerHTML = `<div style="margin-left:auto;">${serverMsg.nickName}</div>`;
            myInfo.isLogin = serverMsg.isLogin;
            myInfo.nickName = serverMsg.nickName;
            myInfo.roomName = serverMsg.roomName;
            tempLoginId = null;

            // 비로그인 방관전중, 로그인시 -> 입장처리
            if (myInfo.roomName !== "waitRoom#") {
              socket.emit("join room", { roomName: myInfo.roomName }); // 현재방에 재입장처리(입장메시지 + 유저목록에 추가되게)
            }
          } else {
            // 중복
            divJoinWrapper.setAttribute("style", "display:block;");
            divLoginInfoWrapper.innerHTML = "";
            alert(tempLoginId + "(은/는) 이미 사용중인 이름 입니다. 다른 이름으로 로그인해 주세요.");
            inputJoin.value = "";
            return;
          }
        }
        renderUserCount(serverMsg.loginUserList);
      });

      socket.on("chat message", function (serverMsg) {
        if (serverMsg.type === "join room" || serverMsg.type === "leave room") {
          // join, leave
          renderRoomJoinLeaveMsg(serverMsg.type, serverMsg.nickName);
          renderRoomUserCount(serverMsg.roomUserList);
          renderRoomUserList(serverMsg.roomUserList);
        } else if (serverMsg.type === "chat msg") {
          // chat
          var item = document.createElement("li");
          item.textContent = `${serverMsg.nickName} > ${serverMsg.msg}`;
          ulChatMsg.appendChild(item);
        }
      });

      /************************************************************************
       * function list
       ***********************************************************************/
      // UTF8 자릿수 계산
      function getByteLengthOfUtf8String(s) {
        let i, b, c;
        if (s != undefined && s != "") {
          for (b = i = 0; (c = s.charCodeAt(i++)); b += c >> 11 ? 3 : c >> 7 ? 2 : 1);
          return b;
        } else {
          return 0;
        }
      }
      // 영문(영어) 체크
      function checkEng(str) {
        const regExp = /[a-zA-Z]/g; // 영어
        if (regExp.test(str)) {
          return true;
        } else {
          return false;
        }
      }

      // 한글 체크
      function checkKor(str) {
        const regExp = /[ㄱ-ㅎㅏ-ㅣ가-힣]/g;
        if (regExp.test(str)) {
          return true;
        } else {
          return false;
        }
      }

      // 숫자 체크
      function checkNum(str) {
        const regExp = /[0-9]/g;
        if (regExp.test(str)) {
          return true;
        } else {
          return false;
        }
      }

      // 공백(스페이스 바) 체크
      function checkSpace(str) {
        if (str.search(/\s/) !== -1) {
          return true; // 스페이스가 있는 경우
        } else {
          return false; // 스페이스 없는 경우
        }
      }

      // 전체 유저수
      function renderUserCount(userList) {
        let allUserCount = userList.length;
        let guestCount = userList.filter((v) => v.nickName === "guest#").length;
        document.querySelector("#div-bottom-status-bar").innerHTML = `All:${allUserCount}(Login:${allUserCount - guestCount} NotLogin:${guestCount})`;
      }

      // room 유저수
      function renderRoomUserCount(roomUserList) {
        let allUserCount = roomUserList.length;
        let guestCount = roomUserList.filter((v) => v.nickName === "guest#").length;
        document.querySelector("#ul-chat-room-status").innerHTML = `All:${allUserCount}(Login:${allUserCount - guestCount} NotLogin:${guestCount})`;
      }

      // room 유저목록
      function renderRoomUserList(roomUserList) {
        document.querySelector("#ul-user-list").innerHTML = "";
        let loginRoomUserList = roomUserList.filter((v) => v.nickName !== "guest#");
        for (const user of loginRoomUserList) {
          var item = document.createElement("li");
          item.textContent = user.nickName;
          document.querySelector("#ul-user-list").appendChild(item);
        }
      }

      // room 출입메시지
      function renderRoomJoinLeaveMsg(type, nickName) {
        let msg;
        if (type === "join room") {
          msg = `${nickName}님 입장`;
        } else {
          msg = `${nickName}님 퇴장`;
        }

        if (nickName !== "guest#") {
          var item = document.createElement("li");
          item.textContent = msg;
          ulChatMsg.appendChild(item);
        }
      }
      // side 선택된 메뉴 표시
      function setSelectedSideMenu(path) {
        // 선택된 메뉴 표시
        let tags = document.querySelectorAll("#ul-room-list li a");
        tags.forEach(function (tag) {
          tag.removeAttribute("class");
        });
        document.querySelector(`#ul-room-list li a[href="${path}"]`)?.setAttribute("class", "selected");
      }
    </script>
  </body>
</html>
